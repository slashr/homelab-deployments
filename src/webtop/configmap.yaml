apiVersion: v1
kind: ConfigMap
metadata:
  name: webtop-scripts
  namespace: webtop
data:
  setup-mmover.sh: |
    #!/bin/bash
    set -e

    # =============================================================================
    # MMOVER - Prevents idle timeout
    # Runs Mon-Fri with daily randomized times, excludes Berlin public holidays
    #
    # Ranges:
    #   Start: 08:30 - 09:30
    #   Pause: 12:15-12:35 to 13:20-13:40
    #   End:   17:30 - 18:30
    #
    # Berlin holidays: New Year, Women's Day, Good Friday, Easter Monday,
    #   Labour Day, Ascension, Whit Monday, Unity Day, Christmas, Boxing Day
    # =============================================================================

    # --- Helper Scripts ---

    cat > /usr/local/bin/mmover.sh << 'EOF'
    #!/bin/bash
    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /tmp/workday.log > /proc/1/fd/1 2>/dev/null || true; }
    export DISPLAY=:1
    eval $(xdotool getmouselocation --shell)
    NEW_X=$((X+50)); NEW_Y=$((Y+50))
    xdotool mousemove $NEW_X $NEW_Y
    log "mmover: moved ($X,$Y) -> ($NEW_X,$NEW_Y)"

    # Push heartbeat metric to SignOz
    TS=$(date +%s)000000000
    curl -sf -X POST "http://signoz-otel-collector.signoz.svc.cluster.local:4318/v1/metrics" \
      -H "Content-Type: application/json" \
      -d "{\"resourceMetrics\":[{\"resource\":{\"attributes\":[{\"key\":\"service.name\",\"value\":{\"stringValue\":\"mmover\"}}]},\"scopeMetrics\":[{\"metrics\":[{\"name\":\"mmover.heartbeat\",\"gauge\":{\"dataPoints\":[{\"asInt\":1,\"timeUnixNano\":\"$TS\"}]}}]}]}]}" \
      >/dev/null 2>&1 || true
    EOF

    cat > /usr/local/bin/chromium-open.sh << 'EOF'
    #!/bin/bash
    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /tmp/workday.log > /proc/1/fd/1 2>/dev/null || true; }
    export DISPLAY=:1
    if pgrep -x chromium >/dev/null; then
      log "chromium: already running"
    else
      su -s /bin/bash -c "DISPLAY=:1 chromium --start-maximized &" abc
      log "chromium: opened"
    fi
    EOF

    cat > /usr/local/bin/chromium-close.sh << 'EOF'
    #!/bin/bash
    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /tmp/workday.log > /proc/1/fd/1 2>/dev/null || true; }
    if pgrep -x chromium >/dev/null; then
      pkill -x chromium
      log "chromium: closed"
    else
      log "chromium: already closed"
    fi
    EOF

    cat > /usr/local/bin/workday-keeper.sh << 'EOF'
    #!/bin/bash
    set -euo pipefail

    LOG="/tmp/workday.log"
    STATE_FILE="/tmp/workday-keeper.state"
    SCHEDULE_FILE="/tmp/workday-schedule"

    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG" > /proc/1/fd/1 2>/dev/null || true; }

    minutes_since_midnight() {
      local h m
      h="$(date +%H)"; m="$(date +%M)"
      echo $((10#$h * 60 + 10#$m))
    }

    # Generate pseudo-random number from seed
    rand() {
      local seed=$1 idx=$2 max=$3
      echo $(( (seed * 31 + idx * 17) % max ))
    }

    # Day of week: 1=Mon..5=Fri
    dow="$(date +%u)"
    [[ "$dow" -gt 5 ]] && exit 0

    # Berlin public holidays (update yearly)
    # Fixed: Jan 1, Mar 8, May 1, Oct 3, Dec 25-26
    # Variable (Easter-based): Good Friday, Easter Monday, Ascension, Whit Monday
    HOLIDAYS_2025="0101 0308 0418 0421 0501 0529 0609 1003 1225 1226"
    HOLIDAYS_2026="0101 0308 0403 0406 0501 0514 0525 1003 1225 1226"
    HOLIDAYS_2027="0101 0308 0326 0329 0501 0506 0517 1003 1225 1226"

    year=$(date +%Y)
    mmdd=$(date +%m%d)
    holidays_var="HOLIDAYS_$year"
    holidays="${!holidays_var:-}"

    if [[ " $holidays " == *" $mmdd "* ]]; then
      log "holiday: skipping (Berlin public holiday)"
      exit 0
    fi

    # Personal vacations - edit /config/vacations.txt (one date per line, YYYY-MM-DD)
    VAC_FILE="/config/vacations.txt"
    if [[ -f "$VAC_FILE" ]] && grep -q "^$(date +%Y-%m-%d)$" "$VAC_FILE" 2>/dev/null; then
      log "vacation: skipping"
      exit 0
    fi

    # Use date as seed for daily randomization
    day_seed=$(date +%Y%m%d)

    # Generate today's schedule (consistent throughout the day)
    # Ranges: start 8:30-9:30, end 17:30-18:30, pause 12:15-12:35 to 13:20-13:40
    start=$((510 + $(rand $day_seed 1 60)))   # 8:30 + 0-59 min
    end=$((1050 + $(rand $day_seed 2 60)))    # 17:30 + 0-59 min
    p1=$((735 + $(rand $day_seed 3 20)))      # 12:15 + 0-19 min
    p2=$((800 + $(rand $day_seed 4 20)))      # 13:20 + 0-19 min

    # Log schedule once per day
    today=$(date +%Y-%m-%d)
    if [[ ! -f "$SCHEDULE_FILE" ]] || [[ "$(cat "$SCHEDULE_FILE" 2>/dev/null)" != "$today" ]]; then
      log "schedule: start=$(printf '%02d:%02d' $((start/60)) $((start%60))) pause=$(printf '%02d:%02d' $((p1/60)) $((p1%60)))-$(printf '%02d:%02d' $((p2/60)) $((p2%60))) end=$(printf '%02d:%02d' $((end/60)) $((end%60)))"
      echo "$today" > "$SCHEDULE_FILE"
    fi

    t="$(minutes_since_midnight)"

    in_work_window=false
    if (( t >= start && t <= end )); then
      if ! (( t >= p1 && t < p2 )); then
        in_work_window=true
      fi
    fi

    prev="unknown"
    [[ -f "$STATE_FILE" ]] && prev="$(cat "$STATE_FILE" || true)"

    if [[ "$in_work_window" == "true" ]]; then
      if [[ "$prev" != "open" ]]; then
        /usr/local/bin/chromium-open.sh || true
        echo "open" > "$STATE_FILE"
      fi
      /usr/local/bin/mmover.sh
    else
      if [[ "$prev" != "closed" ]]; then
        /usr/local/bin/chromium-close.sh || true
        echo "closed" > "$STATE_FILE"
      fi
    fi
    EOF

    chmod +x /usr/local/bin/mmover.sh
    chmod +x /usr/local/bin/chromium-open.sh
    chmod +x /usr/local/bin/chromium-close.sh
    chmod +x /usr/local/bin/workday-keeper.sh

    # --- Cron Schedule ---

    crontab -l 2>/dev/null | grep -v -E 'mmover|chromium|workday' > /tmp/crontab.tmp || true

    cat >> /tmp/crontab.tmp << 'CRON'
    # Run workday keeper every 5 minutes on weekdays
    */5 * * * 1-5 /usr/local/bin/workday-keeper.sh
    CRON

    crontab /tmp/crontab.tmp

    # --- Start crond ---
    pgrep crond || /usr/sbin/crond
