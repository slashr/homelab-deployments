apiVersion: v1
kind: ConfigMap
metadata:
  name: webtop-scripts
  namespace: webtop
data:
  # Main setup script - creates helper scripts and configures cron
  setup-mmover.sh: |
    #!/bin/bash
    set -e

    # =============================================================================
    # MMOVER - Prevents idle timeout
    # Runs Mon-Fri with varied start/end times and midday pause
    #
    # Schedule:
    #   Day   Start   Pause          End
    #   Mon   08:37   12:22-13:28    18:12
    #   Tue   09:08   12:31-13:35    17:42
    #   Wed   08:52   12:18-13:24    18:27
    #   Thu   09:23   12:34-13:38    17:38
    #   Fri   08:45   12:26-13:31    18:05
    # =============================================================================

    # --- Helper Scripts ---

    cat > /usr/local/bin/mmover.sh << 'EOF'
    #!/bin/bash
    export DISPLAY=:1
    eval $(xdotool getmouselocation --shell)
    xdotool mousemove $((X+50)) $((Y+50))

    # Push heartbeat metric to SignOz
    TS=$(date +%s)000000000
    curl -sf -X POST "http://signoz-otel-collector.signoz.svc.cluster.local:4318/v1/metrics" \
      -H "Content-Type: application/json" \
      -d '{"resourceMetrics":[{"resource":{"attributes":[{"key":"service.name","value":{"stringValue":"mmover"}}]},"scopeMetrics":[{"metrics":[{"name":"mmover.heartbeat","gauge":{"dataPoints":[{"asInt":1,"timeUnixNano":"'"$TS"'"}]}}]}]}]}' \
      >/dev/null 2>&1 || true
    EOF

    cat > /usr/local/bin/chromium-open.sh << 'EOF'
    #!/bin/bash
    export DISPLAY=:1
    # Only open if not already running, run as abc user for correct profile
    pgrep -x chromium >/dev/null || su -s /bin/bash -c "DISPLAY=:1 chromium --start-maximized &" abc
    EOF

    cat > /usr/local/bin/chromium-close.sh << 'EOF'
    #!/bin/bash
    pkill -x chromium || true
    EOF

    chmod +x /usr/local/bin/mmover.sh
    chmod +x /usr/local/bin/chromium-open.sh
    chmod +x /usr/local/bin/chromium-close.sh

    # --- Cron Schedule ---

    crontab -l 2>/dev/null | grep -v -E 'mmover|chromium' > /tmp/crontab.tmp || true

    cat >> /tmp/crontab.tmp << 'CRON'
    #==============================================================================
    # MMOVER SCHEDULE (Mon-Fri)
    # Format: min hour * * day command
    #==============================================================================

    # MONDAY (08:37 - 18:12, pause 12:22-13:28)
    37    8      * * 1  /usr/local/bin/chromium-open.sh
    37-59/5 8    * * 1  /usr/local/bin/mmover.sh
    */5   9-11   * * 1  /usr/local/bin/mmover.sh
    0-20/5 12    * * 1  /usr/local/bin/mmover.sh
    28-59/5 13   * * 1  /usr/local/bin/mmover.sh
    */5   14-17  * * 1  /usr/local/bin/mmover.sh
    0-10/5 18    * * 1  /usr/local/bin/mmover.sh
    12    18     * * 1  /usr/local/bin/chromium-close.sh

    # TUESDAY (09:08 - 17:42, pause 12:31-13:35)
    8     9      * * 2  /usr/local/bin/chromium-open.sh
    8-59/5 9     * * 2  /usr/local/bin/mmover.sh
    */5   10-11  * * 2  /usr/local/bin/mmover.sh
    0-30/5 12    * * 2  /usr/local/bin/mmover.sh
    35-59/5 13   * * 2  /usr/local/bin/mmover.sh
    */5   14-16  * * 2  /usr/local/bin/mmover.sh
    0-40/5 17    * * 2  /usr/local/bin/mmover.sh
    42    17     * * 2  /usr/local/bin/chromium-close.sh

    # WEDNESDAY (08:52 - 18:27, pause 12:18-13:24)
    52    8      * * 3  /usr/local/bin/chromium-open.sh
    52-59/5 8    * * 3  /usr/local/bin/mmover.sh
    */5   9-11   * * 3  /usr/local/bin/mmover.sh
    0-15/5 12    * * 3  /usr/local/bin/mmover.sh
    24-59/5 13   * * 3  /usr/local/bin/mmover.sh
    */5   14-17  * * 3  /usr/local/bin/mmover.sh
    0-25/5 18    * * 3  /usr/local/bin/mmover.sh
    27    18     * * 3  /usr/local/bin/chromium-close.sh

    # THURSDAY (09:23 - 17:38, pause 12:34-13:38)
    23    9      * * 4  /usr/local/bin/chromium-open.sh
    23-59/5 9    * * 4  /usr/local/bin/mmover.sh
    */5   10-11  * * 4  /usr/local/bin/mmover.sh
    0-30/5 12    * * 4  /usr/local/bin/mmover.sh
    38-59/5 13   * * 4  /usr/local/bin/mmover.sh
    */5   14-16  * * 4  /usr/local/bin/mmover.sh
    0-35/5 17    * * 4  /usr/local/bin/mmover.sh
    38    17     * * 4  /usr/local/bin/chromium-close.sh

    # FRIDAY (08:45 - 18:05, pause 12:26-13:31)
    45    8      * * 5  /usr/local/bin/chromium-open.sh
    45-59/5 8    * * 5  /usr/local/bin/mmover.sh
    */5   9-11   * * 5  /usr/local/bin/mmover.sh
    0-25/5 12    * * 5  /usr/local/bin/mmover.sh
    31-59/5 13   * * 5  /usr/local/bin/mmover.sh
    */5   14-17  * * 5  /usr/local/bin/mmover.sh
    0-5/5 18     * * 5  /usr/local/bin/mmover.sh
    5     18     * * 5  /usr/local/bin/chromium-close.sh
    CRON

    crontab /tmp/crontab.tmp

    # --- Start crond ---
    pgrep crond || /usr/sbin/crond
