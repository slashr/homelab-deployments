apiVersion: v1
kind: ConfigMap
metadata:
  name: webtop-scripts
  namespace: webtop
data:
  # Main setup script - creates helper scripts and configures cron
  setup-mmover.sh: |
    #!/bin/bash
    set -e

    # =============================================================================
    # MMOVER - Prevents idle timeout
    # Runs Mon-Fri with varied start/end times per day
    #
    # Schedule:
    #   Day   Start   End
    #   Mon   08:37   18:12
    #   Tue   09:08   17:42
    #   Wed   08:52   18:27
    #   Thu   09:23   17:38
    #   Fri   08:45   18:05
    # =============================================================================

    # --- Helper Scripts ---

    cat > /usr/local/bin/mmover.sh << 'EOF'
    #!/bin/bash
    export DISPLAY=:1
    eval $(xdotool getmouselocation --shell)
    xdotool mousemove $((X+50)) $((Y+50))

    # Push heartbeat metric to SignOz
    TS=$(date +%s)000000000
    curl -sf -X POST "http://signoz-otel-collector.signoz.svc.cluster.local:4318/v1/metrics" \
      -H "Content-Type: application/json" \
      -d '{"resourceMetrics":[{"resource":{"attributes":[{"key":"service.name","value":{"stringValue":"mmover"}}]},"scopeMetrics":[{"metrics":[{"name":"mmover.heartbeat","gauge":{"dataPoints":[{"asInt":1,"timeUnixNano":"'"$TS"'"}]}}]}]}]}' \
      >/dev/null 2>&1 || true
    EOF

    cat > /usr/local/bin/chromium-maximize.sh << 'EOF'
    #!/bin/bash
    export DISPLAY=:1
    WIN=$(xdotool search --name "Chromium" | head -1)
    [ -n "$WIN" ] && xdotool windowactivate "$WIN" && xdotool windowsize "$WIN" 100% 100%
    EOF

    cat > /usr/local/bin/chromium-minimize.sh << 'EOF'
    #!/bin/bash
    export DISPLAY=:1
    WIN=$(xdotool search --name "Chromium" | head -1)
    [ -n "$WIN" ] && xdotool windowminimize "$WIN"
    EOF

    chmod +x /usr/local/bin/mmover.sh
    chmod +x /usr/local/bin/chromium-maximize.sh
    chmod +x /usr/local/bin/chromium-minimize.sh

    # --- Cron Schedule ---

    crontab -l 2>/dev/null | grep -v -E 'mmover|chromium' > /tmp/crontab.tmp || true

    cat >> /tmp/crontab.tmp << 'CRON'
    #==============================================================================
    # MMOVER SCHEDULE (Mon-Fri)
    # Format: min hour * * day command
    #==============================================================================

    # MONDAY (08:37 - 18:12)
    37    8      * * 1  /usr/local/bin/chromium-maximize.sh
    37-59/5 8    * * 1  /usr/local/bin/mmover.sh
    */5   9-17   * * 1  /usr/local/bin/mmover.sh
    0-10/5 18    * * 1  /usr/local/bin/mmover.sh
    12    18     * * 1  /usr/local/bin/chromium-minimize.sh

    # TUESDAY (09:08 - 17:42)
    8     9      * * 2  /usr/local/bin/chromium-maximize.sh
    8-59/5 9     * * 2  /usr/local/bin/mmover.sh
    */5   10-16  * * 2  /usr/local/bin/mmover.sh
    0-40/5 17    * * 2  /usr/local/bin/mmover.sh
    42    17     * * 2  /usr/local/bin/chromium-minimize.sh

    # WEDNESDAY (08:52 - 18:27)
    52    8      * * 3  /usr/local/bin/chromium-maximize.sh
    52-59/5 8    * * 3  /usr/local/bin/mmover.sh
    */5   9-17   * * 3  /usr/local/bin/mmover.sh
    0-25/5 18    * * 3  /usr/local/bin/mmover.sh
    27    18     * * 3  /usr/local/bin/chromium-minimize.sh

    # THURSDAY (09:23 - 17:38)
    23    9      * * 4  /usr/local/bin/chromium-maximize.sh
    23-59/5 9    * * 4  /usr/local/bin/mmover.sh
    */5   10-16  * * 4  /usr/local/bin/mmover.sh
    0-35/5 17    * * 4  /usr/local/bin/mmover.sh
    38    17     * * 4  /usr/local/bin/chromium-minimize.sh

    # FRIDAY (08:45 - 18:05)
    45    8      * * 5  /usr/local/bin/chromium-maximize.sh
    45-59/5 8    * * 5  /usr/local/bin/mmover.sh
    */5   9-17   * * 5  /usr/local/bin/mmover.sh
    0-5/5 18     * * 5  /usr/local/bin/mmover.sh
    5     18     * * 5  /usr/local/bin/chromium-minimize.sh
    CRON

    crontab /tmp/crontab.tmp

    # --- Start crond ---
    pgrep crond || /usr/sbin/crond
