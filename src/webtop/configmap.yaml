apiVersion: v1
kind: ConfigMap
metadata:
  name: webtop-scripts
  namespace: webtop
data:
  setup-mmover.sh: |
    #!/bin/bash
    set -e

    # =============================================================================
    # MMOVER - Prevents idle timeout
    # Runs Mon-Fri with varied start/end times and midday pause
    #
    # Schedule:
    #   Day   Start   Pause          End
    #   Mon   08:37   12:22-13:28    18:12
    #   Tue   09:08   12:31-13:35    17:42
    #   Wed   08:52   12:18-13:24    18:27
    #   Thu   09:23   12:34-13:38    17:38
    #   Fri   08:45   12:26-13:31    18:05
    # =============================================================================

    # --- Helper Scripts ---

    cat > /usr/local/bin/mmover.sh << 'EOF'
    #!/bin/bash
    LOG="/tmp/workday.log"
    export DISPLAY=:1
    eval $(xdotool getmouselocation --shell)
    NEW_X=$((X+50)); NEW_Y=$((Y+50))
    xdotool mousemove $NEW_X $NEW_Y
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] mmover: moved ($X,$Y) -> ($NEW_X,$NEW_Y)" >> "$LOG"

    # Push heartbeat metric to SignOz
    TS=$(date +%s)000000000
    curl -sf -X POST "http://signoz-otel-collector.signoz.svc.cluster.local:4318/v1/metrics" \
      -H "Content-Type: application/json" \
      -d "{\"resourceMetrics\":[{\"resource\":{\"attributes\":[{\"key\":\"service.name\",\"value\":{\"stringValue\":\"mmover\"}}]},\"scopeMetrics\":[{\"metrics\":[{\"name\":\"mmover.heartbeat\",\"gauge\":{\"dataPoints\":[{\"asInt\":1,\"timeUnixNano\":\"$TS\"}]}}]}]}]}" \
      >/dev/null 2>&1 || true
    EOF

    cat > /usr/local/bin/chromium-open.sh << 'EOF'
    #!/bin/bash
    LOG="/tmp/workday.log"
    export DISPLAY=:1
    if pgrep -x chromium >/dev/null; then
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] chromium: already running" >> "$LOG"
    else
      su -s /bin/bash -c "DISPLAY=:1 chromium --start-maximized &" abc
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] chromium: opened" >> "$LOG"
    fi
    EOF

    cat > /usr/local/bin/chromium-close.sh << 'EOF'
    #!/bin/bash
    LOG="/tmp/workday.log"
    if pgrep -x chromium >/dev/null; then
      pkill -x chromium
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] chromium: closed" >> "$LOG"
    else
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] chromium: already closed" >> "$LOG"
    fi
    EOF

    cat > /usr/local/bin/workday-keeper.sh << 'EOF'
    #!/bin/bash
    set -euo pipefail

    STATE_FILE="/tmp/workday-keeper.state"

    minutes_since_midnight() {
      local h m
      h="$(date +%H)"; m="$(date +%M)"
      echo $((10#$h * 60 + 10#$m))
    }

    # Day of week: 1=Mon..5=Fri
    dow="$(date +%u)"
    t="$(minutes_since_midnight)"

    # Schedule: start end pause_start pause_end (minutes since midnight)
    case "$dow" in
      1) start=$((8*60+37));  end=$((18*60+12)); p1=$((12*60+22)); p2=$((13*60+28)) ;;
      2) start=$((9*60+8));   end=$((17*60+42)); p1=$((12*60+31)); p2=$((13*60+35)) ;;
      3) start=$((8*60+52));  end=$((18*60+27)); p1=$((12*60+18)); p2=$((13*60+24)) ;;
      4) start=$((9*60+23));  end=$((17*60+38)); p1=$((12*60+34)); p2=$((13*60+38)) ;;
      5) start=$((8*60+45));  end=$((18*60+5));  p1=$((12*60+26)); p2=$((13*60+31)) ;;
      *) exit 0 ;;
    esac

    in_work_window=false
    if (( t >= start && t <= end )); then
      if ! (( t >= p1 && t < p2 )); then
        in_work_window=true
      fi
    fi

    prev="unknown"
    [[ -f "$STATE_FILE" ]] && prev="$(cat "$STATE_FILE" || true)"

    if [[ "$in_work_window" == "true" ]]; then
      if [[ "$prev" != "open" ]]; then
        /usr/local/bin/chromium-open.sh || true
        echo "open" > "$STATE_FILE"
      fi
      /usr/local/bin/mmover.sh
    else
      if [[ "$prev" != "closed" ]]; then
        /usr/local/bin/chromium-close.sh || true
        echo "closed" > "$STATE_FILE"
      fi
    fi
    EOF

    chmod +x /usr/local/bin/mmover.sh
    chmod +x /usr/local/bin/chromium-open.sh
    chmod +x /usr/local/bin/chromium-close.sh
    chmod +x /usr/local/bin/workday-keeper.sh

    # --- Cron Schedule ---

    crontab -l 2>/dev/null | grep -v -E 'mmover|chromium|workday' > /tmp/crontab.tmp || true

    cat >> /tmp/crontab.tmp << 'CRON'
    # Run workday keeper every 5 minutes on weekdays
    */5 * * * 1-5 /usr/local/bin/workday-keeper.sh
    CRON

    crontab /tmp/crontab.tmp

    # --- Start crond ---
    pgrep crond || /usr/sbin/crond
