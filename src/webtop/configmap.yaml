apiVersion: v1
kind: ConfigMap
metadata:
  name: webtop-scripts
  namespace: webtop
data:
  TIMEZONE: Europe/Berlin
  init-cron.sh: |
    #!/bin/sh
    set -e
    log() { echo "[webtop-init] $1" > /proc/1/fd/1 2>/dev/null || true; }

    # Ensure cron daemon is running (Alpine uses crond)
    if command -v crond >/dev/null 2>&1; then
      crond 2>/dev/null || true
      log "crond started"
    fi

    # Install cron entry for workday-keeper (Mon-Fri every 3 minutes)
    crontab -l 2>/dev/null | grep -v workday-keeper > /tmp/crontab.tmp || true
    echo "*/3 * * * 1-5 /scripts/workday-keeper.sh" >> /tmp/crontab.tmp
    crontab /tmp/crontab.tmp
    log "cron installed: workday-keeper"

  mmover.sh: |
    #!/bin/sh
    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" > /proc/1/fd/1 2>/dev/null || true; }
    export DISPLAY=:1

    jitter=$((RANDOM % 90))
    sleep "$jitter"

    action=$((RANDOM % 3))

    case "$action" in
      0)
        eval "$(xdotool getmouselocation --shell)"
        dist=$((20 + RANDOM % 60))
        dir=$((RANDOM % 8))
        case "$dir" in
          0) dx=$dist;  dy=0 ;;
          1) dx=$dist;  dy=$dist ;;
          2) dx=0;      dy=$dist ;;
          3) dx=-$dist; dy=$dist ;;
          4) dx=-$dist; dy=0 ;;
          5) dx=-$dist; dy=-$dist ;;
          6) dx=0;      dy=-$dist ;;
          7) dx=$dist;  dy=-$dist ;;
        esac
        NEW_X=$((X + dx))
        NEW_Y=$((Y + dy))
        [ "$NEW_X" -lt 10 ] && NEW_X=10
        [ "$NEW_Y" -lt 10 ] && NEW_Y=10
        [ "$NEW_X" -gt 3000 ] && NEW_X=3000
        [ "$NEW_Y" -gt 2000 ] && NEW_Y=2000

        steps=$((5 + RANDOM % 6))
        step_dx=$(( (NEW_X - X) / steps ))
        step_dy=$(( (NEW_Y - Y) / steps ))
        cur_x=$X
        cur_y=$Y
        i=1
        while [ "$i" -lt "$steps" ]; do
          cur_x=$((cur_x + step_dx))
          cur_y=$((cur_y + step_dy))
          xdotool mousemove "$cur_x" "$cur_y"
          sleep 0.0$((10 + RANDOM % 40))
          i=$((i + 1))
        done
        xdotool mousemove "$NEW_X" "$NEW_Y"
        log "mmover: mouse ($X,$Y) -> ($NEW_X,$NEW_Y) [${steps} steps, ${jitter}s jitter]"
        ;;
      1)
        scroll_amount=$((1 + RANDOM % 3))
        scroll_dir=$((RANDOM % 2))
        return_scroll=$((RANDOM % 3))

        if [ "$scroll_dir" -eq 0 ]; then
          i=1; while [ "$i" -le "$scroll_amount" ]; do xdotool click 5; i=$((i+1)); done
        else
          i=1; while [ "$i" -le "$scroll_amount" ]; do xdotool click 4; i=$((i+1)); done
        fi

        if [ "$return_scroll" -eq 0 ]; then
          sleep 0.$((2 + RANDOM % 6))
          if [ "$scroll_dir" -eq 0 ]; then
            i=1; while [ "$i" -le "$scroll_amount" ]; do xdotool click 4; i=$((i+1)); done
          else
            i=1; while [ "$i" -le "$scroll_amount" ]; do xdotool click 5; i=$((i+1)); done
          fi
          log "mmover: scroll ($scroll_amount lines, return) [${jitter}s jitter]"
        else
          log "mmover: scroll ($scroll_amount lines, one-way) [${jitter}s jitter]"
        fi
        ;;
      2)
        xdotool key alt+Tab
        sleep 0.$((3 + RANDOM % 9))
        xdotool key alt+Tab
        log "mmover: window cycle [${jitter}s jitter]"
        ;;
    esac

  ff-o.sh: |
    #!/bin/sh
    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" > /proc/1/fd/1 2>/dev/null || true; }
    BROWSER_ALREADY_FLAG="/tmp/browser-open.already"
    export DISPLAY=:1

    if pgrep -x chromium >/dev/null; then
      if [ ! -f "$BROWSER_ALREADY_FLAG" ]; then
        log "browser: already running"
        touch "$BROWSER_ALREADY_FLAG"
      fi
      exit 0
    fi

    rm -f "$BROWSER_ALREADY_FLAG"
    log "browser: starting"
    DISPLAY=:1 chromium &

  ff-c.sh: |
    #!/bin/sh
    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" > /proc/1/fd/1 2>/dev/null || true; }
    BROWSER_ALREADY_FLAG="/tmp/browser-open.already"
    if pgrep -x chromium >/dev/null; then
      pkill -x chromium
      log "browser: closed"
    else
      log "browser: already closed"
    fi
    rm -f "$BROWSER_ALREADY_FLAG"

  workday-keeper.sh: |
    #!/bin/sh
    set -eu

    STATE_FILE="/tmp/workday-keeper.state"
    SCHEDULE_FILE="/tmp/workday-schedule"

    log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" > /proc/1/fd/1 2>/dev/null || true; }

    minutes_since_midnight() {
      h="$(date +%H)"; m="$(date +%M)"
      echo $((10#$h * 60 + 10#$m))
    }

    rand() {
      seed=$1; idx=$2; max=$3
      echo $(( (seed * 31 + idx * 17) % max ))
    }

    dow="$(date +%u)"
    [ "$dow" -gt 5 ] && exit 0

    HOLIDAYS_2025="0101 0308 0418 0421 0501 0529 0609 1003 1225 1226"
    HOLIDAYS_2026="0101 0308 0403 0406 0501 0514 0525 1003 1225 1226"
    HOLIDAYS_2027="0101 0308 0326 0329 0501 0506 0517 1003 1225 1226"
    HOLIDAYS_2028="0101 0308 0414 0417 0501 0525 0605 1003 1225 1226"

    VACATIONS_2025=""
    VACATIONS_2026="0107 0320-0406"
    VACATIONS_2027=""
    VACATIONS_2028=""

    year=$(date +%Y)
    mmdd=$(date +%m%d)
    mmdd_num=$((10#$mmdd))

    holidays_var="HOLIDAYS_${year}"
    holidays=$(eval echo \$${holidays_var} || true)
    echo " $holidays " | grep -q " $mmdd " && { log "holiday: skipping"; exit 0; }

    vacations_var="VACATIONS_${year}"
    vacations=$(eval echo \$${vacations_var} || true)
    for v in $vacations; do
      case "$v" in
        *-*)
          start=${v%-*}; end=${v#*-}
          start_num=$((10#$start))
          end_num=$((10#$end))
          if [ "$mmdd_num" -ge "$start_num" ] && [ "$mmdd_num" -le "$end_num" ]; then
            log "vacation: skipping"; exit 0
          fi
          ;;
        *)
          [ "$v" = "$mmdd" ] && { log "vacation: skipping"; exit 0; }
          ;;
      esac
    done

    day_seed=$(date +%Y%m%d)
    start=$((510 + $(rand $day_seed 1 60)))
    end=$((1050 + $(rand $day_seed 2 60)))
    p1=$((735 + $(rand $day_seed 3 20)))
    p2=$((800 + $(rand $day_seed 4 20)))

    today=$(date +%Y-%m-%d)
    if [ ! -f "$SCHEDULE_FILE" ] || [ "$(cat "$SCHEDULE_FILE" 2>/dev/null)" != "$today" ]; then
      log "schedule: start=$(printf '%02d:%02d' $((start/60)) $((start%60))) pause=$(printf '%02d:%02d' $((p1/60)) $((p1%60)))-$(printf '%02d:%02d' $((p2/60)) $((p2%60))) end=$(printf '%02d:%02d' $((end/60)) $((end%60)))"
      echo "$today" > "$SCHEDULE_FILE"
    fi

    t="$(minutes_since_midnight)"

    in_work_window=false
    if [ "$t" -ge "$start" ] && [ "$t" -le "$end" ]; then
      if ! ([ "$t" -ge "$p1" ] && [ "$t" -lt "$p2" ]); then
        in_work_window=true
      fi
    fi

    prev="unknown"
    [ -f "$STATE_FILE" ] && prev="$(cat "$STATE_FILE" 2>/dev/null || true)"

    if [ "$in_work_window" = "true" ]; then
      if [ "$prev" != "open" ]; then
        if [ "$t" -ge "$p2" ]; then
          log "browser: opened (break over $(printf '%02d:%02d' $((p2/60)) $((p2%60))))"
        else
          log "browser: opened (work starts $(printf '%02d:%02d' $((start/60)) $((start%60))))"
        fi
        /scripts/ff-o.sh || true
        echo "open" > "$STATE_FILE"
      fi
      /scripts/mmover.sh
    else
      if [ "$prev" != "closed" ]; then
        if [ "$t" -ge "$p1" ] && [ "$t" -lt "$p2" ]; then
          log "browser: closed (break starts $(printf '%02d:%02d' $((p1/60)) $((p1%60))))"
        else
          log "browser: closed (work over $(printf '%02d:%02d' $((end/60)) $((end%60))))"
        fi
        /scripts/ff-c.sh || true
        echo "closed" > "$STATE_FILE"
      fi
    fi
